{% extends 'base.html' %}
{% load static %}
{% block title %}
    PyComms
{% endblock %}
{% block content %}
<!-- Container fluid -->
<div class="bg-primary pt-10 pb-21"></div>
<div class="container-fluid mt-n22 px-6">
  <div class="row">
    <div class="col-lg-12 col-md-12 col-12">
      <!-- Page header -->
      <div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="mb-2 mb-lg-0">
            <h3 class="mb-0  text-white">PyComms</h3>
          </div>
          <div>
            <button type="button" class="btn btn-white" data-bs-toggle="modal" data-bs-target="#new-channel">Create New Channel</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="new-channel" tabindex="-1" role="dialog" aria-labelledby="ChannelModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form action="" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="ChannelModalLabel">Create New Channel</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            {{ form.name }}
                            {{ form.name.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password (optional)</label>
                            {{ form.password }}
                            {{ form.password.errors }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create Channel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordModalLabel">Enter Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="password" id="passwordInput" class="form-control" placeholder="Enter password">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="passwordSubmit" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-12 col-12 mt-6">
      <!-- card -->
      <div class="card ">
        <!-- card body -->
        <div class="card-body">
          <!-- heading -->
          <div class="d-flex justify-content-between align-items-center
            mb-3">
            <div>
              <h4 class="mb-0">Members</h4>
            </div>
            <div class="icon-shape icon-md bg-light-primary text-primary
              rounded-2">
              <i class="bi bi-people fs-4"></i>
            </div>
          </div>
          <!-- project number -->
          <div>
            <h1 class="fw-bold">{{ site_data.members }}</h1>
            <p class="mb-0">
              <span class="text-dark me-2"></span>Signed up members
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-12 col-12 mt-6">
      <!-- card -->
      <div class="card ">
        <!-- card body -->
        <div class="card-body">
          <!-- heading -->
          <div class="d-flex justify-content-between align-items-center
            mb-3">
            <div>
              <h4 class="mb-0">Channels</h4>
            </div>
            <div class="icon-shape icon-md bg-light-primary text-primary
              rounded-2">
              <i class="bi bi-chat-left-dots fs-4"></i>
            </div>
          </div>
          <!-- project number -->
          <div>
            <h1 class="fw-bold">{{ site_data.channels }}</h1>
            <p class="mb-0">
              <span class="text-dark me-2"></span>Created Channels
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-12 col-12 mt-6">
      <!-- card -->
      <div class="card ">
        <!-- card body -->
        <div class="card-body">
          <!-- heading -->
          <div class="d-flex justify-content-between align-items-center
            mb-3">
            <div>
              <h4 class="mb-0">Online</h4>
            </div>
            <div class="icon-shape icon-md bg-light-primary text-primary
              rounded-2">
              <i class="bi bi-wifi fs-4"></i>
            </div>
          </div>
          <!-- project number -->
          <div>
            <h1 class="fw-bold">{{ site_data.online }}</h1>
            <p class="mb-0">
              <span class="text-dark me-2"></span>Online Users
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-12 col-12 mt-6">
      <!-- card -->
      <div class="card ">
        <!-- card body -->
        <div class="card-body">
          <!-- heading -->
          <div class="d-flex justify-content-between align-items-center
            mb-3">
            <div>
              <h4 class="mb-0">Teams</h4>
            </div>
            <div class="icon-shape icon-md bg-light-primary text-primary
              rounded-2">
              <i class="bi bi-bullseye fs-4"></i>
            </div>
          </div>
          <!-- project number -->
          <div>
            <h1 class="fw-bold">Soon...</h1>
            <p class="mb-0">
              <span class="text-warning me-2">5%</span>on progress
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- row  -->
  <div class="row mt-6">
    <div class="col-md-12 col-12">
      <!-- card  -->
      <div class="card">
        <!-- card header  -->
        <div class="card-header bg-white  py-4">
          <h4 class="mb-0">Active Channels</h4>
        </div>
        <!-- table  -->
        <div class="table-responsive">
          <table class="table text-nowrap mb-0">
          <div id="user-info" data-username="{{ request.user.username }}" data-userId="{{ request.user.id }}"></div>
          <div id="remoteAudioContainer" style="display: none;">></div>
          {% csrf_token %}
            <thead class="table-light">
                <tr>
                    <th>Channel Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Online</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for channel in channels %}
                <tr data-channel-id="{{ channel.id }}">
                    <td class="align-middle">{{ channel.name }}</td>
                    <td class="align-middle">Private</td>
                    <td class="align-middle">{% if channel.password|length > 1 %}<span class="badge bg-warning">locked</span>{% else %}<span class="badge bg-success">Unlocked</span>{% endif %}</td>
                    <td class="align-middle">
                        <div class="avatar-group">
                            {% for member in channel.members.all %}
                                {% if member.active %}
                                    <span class="avatar avatar-sm">
                                        <img src="{% if member.user.avatar %}{{ member.user.avatar.url }}{% else %}{% static 'images/avatar.jpg' %}{% endif %}" alt="#" class="rounded-circle">
                                    </span>
                                {% endif %}
                            {% endfor %}
                            {% if channel.extra_count > 0 %}
                                <span class="avatar avatar-sm avatar-primary">
                                    <span class="avatar-initials rounded-circle fs-6">
                                        +{{ channel.extra_count }}
                                    </span>
                                </span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="align-middle">
                        <button class="btn btn-primary btn-sm btn-join">Join</button>
                    </td>
                </tr>
                <tr class="hidden">
                    <td colspan="5">
                        <div id="channel-details-{{ channel.id }}" class="collapse">
                            <table class="table user-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Country</th>
                                        <th>Ping</th>
                                    </tr>
                                </thead>
                                <tbody class="user-list">
                                    <!-- Users will be added here dynamically -->
                                </tbody>
                            </table>
                            <!-- Chat box -->
                            <div id="chatbox-{{ channel.id }}" class="card mt-3">
                                <div class="card-header">
                                    Channel Chats
                                </div>
                                <div class="card-body d-flex flex-column justify-content-between position-relative" style="height: 300px;">
                                    <div class="chat-messages p-4 overflow-auto">
                                        {% for message in channel.messages.all %}
                                            {% if request.user == message.sender %}
                                                <div class="chat-message-left pb-4">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <img src="{% if message.sender.avatar %}{{ message.sender.avatar.url }}{% else %}/static/images/avatar.jpg{% endif %}" class="rounded-circle mr-1" width="40" height="40" alt="avatar">
                                                        <div class="text-muted small text-nowrap mt-2">{{ message.timestamp|date:"H:i:s" }}</div>
                                                    </div>
                                                    <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                                                        <div class="font-weight-bold mb-1">You</div>
                                                        {{ message.content }}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="chat-message-right pb-4">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <img src="{% if message.sender.avatar %}{{ message.sender.avatar.url }}{% else %}/static/images/avatar.jpg{% endif %}" class="rounded-circle mr-1" width="40" height="40" alt="avatar">
                                                        <div class="text-muted small text-nowrap mt-2">{{ message.timestamp|date:"H:i:s" }}</div>
                                                    </div>
                                                    <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                                                        <div class="font-weight-bold mb-1">{{ message.sender.full_name }}</div>
                                                        {{ message.content }}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="flex-grow-0 py-3 px-4 border-top">
                                        <div class="input-group">
                                            <input id="input-chatbox-{{ channel.id }}" type="text" class="form-control" placeholder="Type your message">
                                            <button id="button-chatbox-{{ channel.id }}" class="btn btn-primary">Send</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- card footer  -->
        <div class="card-footer bg-white text-center">
            Crafted with care by <a href="https://www.saeedmasoudie.ir/" class="link-primary">Saeed Masoudi</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_footer %}
    <script src="{% static 'js/channels.js' %}"></script>
{% endblock %}